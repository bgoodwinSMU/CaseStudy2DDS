---
title: "Project 2 DS6306"
author: "Ben Goodwin"
date: "11/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#############################################
#                                           #
#               Libraries                   #
#                                           #
#############################################

#Missingness maps
library(naniar)

#For reading .xlsx
library(readxl)

#General data manipulation
library(dplyr)
library(tidyverse)
library(psych)

#Plot generations
library(ggplot2)
library(GGally)
#Plotting PCA 
library(ggfortify)
library(pca3d)


```






```{r}
#############################################
#                                           #
#           Read in data                    #
#                                           #
#############################################

#Read in primary data ("CaseStudy2-data.txt")
primaryData <- read.table("CaseStudy2-data.txt",sep = ",",header = TRUE)
#Peek data
#head(primaryData)

###############Read in other datasets###############

#Case study 2 classification example dataset ("Case2PredictionsClassifyEXAMPLE.txt")
predictionsClassify <- read.table("Case2PredictionsClassifyEXAMPLE.txt",sep = ",",header = TRUE)

#Case study 2 predictions regression example dataset ("Case2PredictionsRegressEXAMPLE.txt")
predictionsRegression <- read.table("Case2PredictionsRegressEXAMPLE.txt",sep = ",",header = TRUE)

#Case study 2 compset no attrition dataset ("CaseStudy2CompSet No Attrition.txt")
compsetNoAttrition <- read.table("CaseStudy2CompSet No Attrition.txt",sep = ",",header = TRUE)

#Case study 2 compset no salary dataset ("CaseStudy2CompSet No Salary.xlsx")
compsetNoSalary <- read_excel("CaseStudy2CompSet No Salary.xlsx")

```



```{r}
#############################################
#                                           #
#       EDA and Data Preperation            #
#                Part 1                     #
#############################################

#Examine primary dataset for missingness
primaryDatMiss <- vis_miss(primaryData)
primaryDatMiss

#Examine Case study 2 classification example dataset
predictionClassiftMiss <- vis_miss(predictionsClassify)
predictionClassiftMiss

#Case study 2 predictions regression example dataset
predictionsRegressionMiss <- vis_miss(predictionsRegression)
predictionsRegressionMiss

#Case study 2 compset no attrition dataset 
compsetNoAttritionMiss <- vis_miss(compsetNoAttrition)
compsetNoAttritionMiss

#Case study 2 compset no salary dataset
compsetNoSalaryMiss <- vis_miss(compsetNoSalary)
compsetNoSalaryMiss



```

```{r}

#############################################
#                                           #
#       EDA and Data Preperation            #
#                Part 2                     #
#                                           #
#############################################

#Convert all CHR variables to factors to examine pairs data
primaryData_factor <- primaryData %>%
  mutate_if(sapply(primaryData, is.character), as.factor)

#Convert all CHR variables to ints for COV 
primaryData_int <- primaryData_factor %>%
  mutate_if(sapply(primaryData_factor, is.factor), as.integer)


#Look at dataset from with a wide lense
describe(primaryData_factor)

####Look at some of the variables as histograms####

#Histogram of age
hist(primaryData_factor$Age)

#Histogram of working years
hist(primaryData_factor$TotalWorkingYears)

#Histogram of Monthly Income
hist(primaryData_factor$MonthlyIncome)

####Look at some of the variables as plots####

#Look at relationship between monthly income and wokring years
plot(primaryData_factor$TotalWorkingYears,primaryData_factor$MonthlyIncome)

#Look at relationship between monthly income and attrition
plot(primaryData_factor$Attrition,primaryData_factor$MonthlyIncome)


#Look at relationship between distance from home and attrition
plot(primaryData_factor$Attrition,primaryData_factor$DistanceFromHome)

#Look at relationship between years since last promotion and attrition
plot(primaryData_factor$Attrition,primaryData_factor$YearsSinceLastPromotion)

#Look at relationship between distance job satisfaction and attrition
plot(primaryData_factor$Attrition,primaryData_factor$JobSatisfaction)

#Look at relationship between environment satisfaction and attrition
plot(primaryData_factor$Attrition,primaryData_factor$EnvironmentSatisfaction)








```
```{r}
#############################################
#                                           #
#            Identify factors               #
#              that lead to                 #
#                attrition                  #
#                                           #
#                                           #
#############################################

#First method will be to use PCA (principal component analysis)

#Lets look at the covairance matrix of the attrition dataset and attempt to scale it all

#A bit of data preperation
pcaDat <- primaryData_int[,c(2:4,6:9,12:13,15:20,22:36)]
pcaDat

PCAdat_factor <- primaryData_int[,c(2:4,6:9,12:13,15:20,22:36)]
#PCAdat_factor[,c(2,3,4,7,9,12,14,17,18)] <- as.integer(PCAdat_factor[,c(2,3,4,7,9,12,14,17,18)])
PCAdat_factor$Attrition <- as.factor(PCAdat_factor$Attrition)
PCAdat_factor$Attrition <- factor(PCAdat_factor$Attrition,levels = c(1,2),labels = c("No","Yes"))


S <- cov(pcaDat[,c(1,3:30)])
S

#Examine total variance, (sum of the eigenvalues of S)
sum(diag(S))

#Compute the eigenvalues and corresponding eigenvectors of S
s.eigen <- eigen(S)
s.eigen

#Use eigenvalues to find the proportion of the total variance explained by the components
for (s in s.eigen$values) {
  print(s / sum(s.eigen$values))
}

#It would seem that the first two principal components account for nearly 99% of the total variance

#Create a plot to determine the proportion of variance explained by each subsequential eigenvalue
plot(s.eigen$values, xlab="Eigenvalue Number",ylab="Eigenvalue Size",main="Scree Graph")+lines(s.eigen$values)


####Use R packages to confirm results####
quitters.pca <- prcomp(pcaDat[,c(1,3:30)])
quitters.pca

#Components reported by package are equal to earlier computations

#Look at proportion of variance explained by components
summary(quitters.pca)

#Plot the principal components
pca.plot <- autoplot(quitters.pca,data=PCAdat_factor,colour='Attrition',loadings=TRUE,loadings.colour="blue",loadings.label=TRUE) 
pca.plot

#The points of the two groups are clustered somewhat, however there appears to be more attrition at the right of the graph.  The data does not appear to depart widely from multivariate normality.  

#Create new df for R
rDat <- pcaDat[,c(1,3:16,18:21,23:30)]
rDat
#Lets use R instead of S 
R <- cor(rDat)
R

#Again find Eigenvalues and Eigenvectors for R
r.eigen <- eigen(R)
r.eigen


#Compute proportion of total variance explained by the eigenvalues
for (r in r.eigen$values) {
  print(r/sum(r.eigen$values))
  
}

#PCA (scaled)
quitters.pca.scaled <- prcomp(rDat,scale = TRUE)
quitters.pca.scaled

#Summary of scaled 
summary(quitters.pca.scaled)

#Plot elbow plot to determine components required
plot(r.eigen$values, xlab="Eigenvalue Number",ylab="Eigenvalue Size",main="Scree Graph")+lines(r.eigen$values)

#Look at Visualized data
pca.plot.scaled <- autoplot(quitters.pca.scaled,data = PCAdat_factor,colour='Attrition',loadings=TRUE,loadings.colour="blue",loadings.label=TRUE)
pca.plot.scaled



#Check out a 3D plot to attempt to determine best components to use
pca3d(quitters.pca.scaled,group=PCAdat_factor$Attrition,legend = "topleft",biplot = TRUE,biplot.vars = 3)


####Plots of PCs####

#First plot using autoplot
autoplot(quitters.pca.scaled,data = PCAdat_factor,colour='Attrition',loadings=TRUE,loadings.colour="blue",loadings.label=TRUE,x=1,y=2)

#Other plots using ggbiplot
#biplot with ellipse, pc1,2
p <- ggbiplot::ggbiplot(quitters.pca.scaled,ellipse = TRUE,circle = FALSE,groups = PCAdat_factor$Attrition,choices = 1:2,varname.size = 3,varname.adjust = 2,alpha = 0.5)+ggtitle("PCA of Attrition Dataset PC1,PC2")+theme_minimal()
p

####PC1 Interpretation####
#High positive loadings for years at company, years in current role, and .4 (highest) in total working years,years with current manager, monthly income, job level
#This component seems to measure employee stability, and seemingly perhaps overall success at a given company
#This component is the primary PC and explains 17.35% of the variation in the data

####PC2 Interpretation####
#Large negative loadings on age and number of companies employee worked at, this component measures an employees attrition based on age
#This component is the secondary PC and explains 7.0% of the variation in the data

#biplot without ellipse pc1,2
p2 <- ggbiplot::ggbiplot(quitters.pca.scaled,ellipse = FALSE,circle = FALSE,groups = PCAdat_factor$Attrition,choices = 1:2,varname.size = 3,varname.adjust = 2,alpha = 0.5)+ggtitle("PCA of Attrition Dataset PC1,PC2")+theme_minimal()
p2

####PC2 Interpretation####
#Large negative loadings on age and number of companies employee worked at, this component measures an employees attrition based on age
#This component is the secondary PC and explains 7.0% of the variation in the data

#biplot with ellipse, pc2,3
p3 <- ggbiplot::ggbiplot(quitters.pca.scaled,ellipse = TRUE,circle = FALSE,groups = PCAdat_factor$Attrition,choices = 2:3,varname.size = 3,varname.adjust = 2,alpha = 0.5)+ggtitle("PCA of Attrition Dataset PC2,PC3")+theme_minimal()
p3

#biplot without ellipse, pc2,3
p4 <- ggbiplot::ggbiplot(quitters.pca.scaled,ellipse = FALSE,circle = FALSE,groups = PCAdat_factor$Attrition,choices = 2:3,varname.size = 3,varname.adjust = 2,alpha = 0.5)+ggtitle("PCA of Attrition Dataset PC2,PC3")+theme_minimal()
p4

####PC3 Interpretation####
#Very large negative loadings on percent salary hike and performance rating.  This component seems to measure an employees recordabable performance.  
##This component is the tertiary PC and explains 6.75% of the variation in the data, making it rougly as important as 1

#biplot with ellipse, pc3,4
p5 <- ggbiplot::ggbiplot(quitters.pca.scaled,ellipse = TRUE,circle = FALSE,groups = PCAdat_factor$Attrition,choices = 3:4,varname.size = 3,varname.adjust = 2,alpha = 0.5)+ggtitle("PCA of Attrition Dataset PC3,PC4")+theme_minimal()
p5

#biplot without ellipse, pc3,4
p6 <- ggbiplot::ggbiplot(quitters.pca.scaled,ellipse = FALSE,circle = FALSE,groups = PCAdat_factor$Attrition,choices = 3:4,varname.size = 3,varname.adjust = 2,alpha = 0.5)+ggtitle("PCA of Attrition Dataset PC3,PC4")+theme_minimal()
p6

####PC4 Interpretation####
#Negative loadings on department, martial status, and performance ratings.  This component appears to measure employees with roles that could potentially be all consuming
#This component is the fourth PC and explains 6.33% of the variation in the data

#################################
#Note!
#These four PC's only explain 37.46232% of the variation in the data, I will use and additional 11 PC's for further analysis.  I have not included loading plots for these #as the interpretation is too nuanced. 

#15 PCs capture 81% of the variance in the data (0.1735757+0.07028831+0.06750148+0.06325877+0.05967773+0.04353646+0.04226411+0.04068733+0.03963922+0.03889302+0.03744872+0.036015730+0.03450615+0.03405034+0.03339357)
```

